<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
<title>ICT Mela AR — Virinchi College (Prototype)</title>
<style>
  :root{--accent:#ffd166;--bg:#031028;--muted:#cfe8ff;}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#031028,#063559);color:#fff;font-family:Arial,Helvetica,sans-serif}
  #app{position:relative;height:100vh;overflow:hidden}
  video#camera{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1);} /* mirror for better UX */
  canvas#qrCanvas{display:none}
  .overlay{position:absolute;left:0;right:0;top:0;bottom:0;pointer-events:none}
  .hud{position:absolute;left:12px;top:12px;z-index:50;background:rgba(0,0,0,0.35);backdrop-filter:blur(4px);padding:8px;border-radius:8px}
  .btn{background:var(--accent);color:#06283d;padding:8px 10px;border-radius:8px;text-decoration:none;font-weight:700;margin-right:6px;cursor:pointer}
  .marker{position:absolute;top:40%;transform:translate(-50%,-50%);pointer-events:auto;z-index:40;}
  .marker .pin{width:120px;padding:8px 10px;border-radius:12px;background:rgba(255,255,255,0.06);color:var(--muted);text-align:center;border:2px solid rgba(255,255,255,0.06)}
  .marker .pin h4{margin:0;font-size:14px;color:var(--accent)}
  .panel{position:absolute;left:12px;bottom:12px;z-index:60;background:rgba(0,0,0,0.45);padding:10px;border-radius:10px;width:calc(100% - 28px);color:#e6f2ff}
  #poiList{display:flex;gap:8px;overflow:auto;padding:6px}
  .poiItem{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;white-space:nowrap;cursor:pointer}
  #qrResult{font-weight:700;color:#a7f3d0;margin-top:6px}
  #instructions{font-size:13px;color:#cfe8ff;opacity:0.9}
  footer{position:absolute;right:12px;bottom:12px;color:#cfe8ff;opacity:0.8;font-size:12px}
</style>
</head>
<body>
<div id="app">
  <video id="camera" autoplay playsinline></video>
  <canvas id="qrCanvas"></canvas>

  <div class="overlay">
    <div class="hud">
      <button id="btnToggleQR" class="btn">Start QR Scanner</button>
      <button id="btnCenter" class="btn">Center</button>
      <span id="status" style="margin-left:8px;font-size:13px;color:#cfe8ff">Initializing…</span>
    </div>

    <!-- Markers container -->
    <div id="markers"></div>

    <div class="panel">
      <div id="instructions"><strong>ICT Mela 6.0 — Virinchi College</strong> &mdash; Use camera to find AR markers around campus. Tap a POI below or walk to it. Tap a marker to reveal the secret word and a printable QR.</div>
      <div id="poiList"></div>
      <div id="qrResult"></div>
    </div>
  </div>

  <footer>Prototype — Works on Android Chrome / iOS Safari (HTTPS required for camera & geolocation)</footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
/*
Prototype features:
- camera background (getUserMedia)
- frame-based QR scanning (jsQR)
- GPS-based POIs with bearing/distance; approximate horizontal placement using device heading
- tap marker -> show secret word and QR image (printable)

IMPORTANT:
- Serve over HTTPS (or localhost) for camera + geolocation + device orientation permissions.
- Replace the sample POI coordinates in poiData with precise GPS coordinates for Virinchi College poster locations.
*/

const video = document.getElementById('camera');
const qrCanvas = document.getElementById('qrCanvas');
const qrCtx = qrCanvas.getContext('2d');
const btnToggleQR = document.getElementById('btnToggleQR');
const status = document.getElementById('status');
const markersEl = document.getElementById('markers');
const poiListEl = document.getElementById('poiList');
const qrResult = document.getElementById('qrResult');

let scanning = false;
let stream = null;
let watchId = null;
let heading = null;
let userPos = null;

// *** Replace these sample coordinates with actual campus coordinates for Virinchi College ***
let poiData = [
  {id:1, title:"Main Entrance", lat:27.7047, lon:85.3156, secret:"Kickstart"},
  {id:2, title:"Robo Soccer Zone", lat:27.7052, lon:85.3160, secret:"Sensors"},
  {id:3, title:"IoT Exhibition", lat:27.7056, lon:85.3165, secret:"SmartHub"},
  {id:4, title:"Library", lat:27.7059, lon:85.3151, secret:"Compile"},
  {id:5, title:"Computer Lab", lat:27.7062, lon:85.3158, secret:"Applause"}
];

async function startCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}, audio:false});
    video.srcObject = stream;
    await video.play();
    status.textContent = "Camera ready";
    qrCanvas.width = video.videoWidth || 640;
    qrCanvas.height = video.videoHeight || 480;
  } catch(e){
    status.textContent = "Camera error: " + e.message;
  }
}

btnToggleQR.addEventListener('click', () => {
  scanning = !scanning;
  btnToggleQR.textContent = scanning ? "Stop QR Scanner" : "Start QR Scanner";
  qrResult.textContent = "";
  if(scanning) scanLoop();
});

function scanLoop(){
  if(!scanning) return;
  if(video.readyState === video.HAVE_ENOUGH_DATA){
    qrCanvas.width = video.videoWidth;
    qrCanvas.height = video.videoHeight;
    qrCtx.drawImage(video, 0, 0, qrCanvas.width, qrCanvas.height);
    const imageData = qrCtx.getImageData(0,0,qrCanvas.width, qrCanvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height, {inversionAttempts:"attemptBoth"});
    if(code){
      scanning = false;
      btnToggleQR.textContent = "Start QR Scanner";
      qrResult.innerHTML = "QR Detected: <span style='color:#ffd166'>"+escapeHtml(code.data)+"</span>";
      if(code.data.startsWith('http')){
        window.open(code.data, '_blank');
      }
    }
  }
  requestAnimationFrame(scanLoop);
}

function toRadians(d){ return d * Math.PI / 180; }
function toDegrees(r){ return r * 180 / Math.PI; }
function bearingTo(lat1, lon1, lat2, lon2){
  const y = Math.sin(toRadians(lon2-lon1)) * Math.cos(toRadians(lat2));
  const x = Math.cos(toRadians(lat1))*Math.sin(toRadians(lat2)) - Math.sin(toRadians(lat1))*Math.cos(toRadians(lat2))*Math.cos(toRadians(lon2-lon1));
  const brng = toDegrees(Math.atan2(y,x));
  return (brng + 360) % 360;
}
function distanceTo(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const dLat = toRadians(lat2-lat1);
  const dLon = toRadians(lon2-lon1);
  const a = Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(toRadians(lat1))*Math.cos(toRadians(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

function updateMarkers(){
  markersEl.innerHTML = '';
  if(!userPos){ status.textContent = "Waiting for GPS…"; return; }
  poiData.forEach(p => {
    const brng = bearingTo(userPos.lat, userPos.lon, p.lat, p.lon);
    const dist = Math.round(distanceTo(userPos.lat, userPos.lon, p.lat, p.lon));
    let relative = 0;
    if(heading !== null){
      let diff = (brng - heading + 540) % 360 - 180;
      relative = diff;
    } else {
      relative = (brng - 90);
    }
    const maxAngle = 60;
    const clamped = Math.max(-maxAngle, Math.min(maxAngle, relative));
    const xPerc = 50 + (clamped / maxAngle) * 45;
    const marker = document.createElement('div');
    marker.className = 'marker';
    marker.style.left = xPerc + '%';
    marker.innerHTML = `<div class="pin" data-id="${p.id}"><h4>${p.title}</h4><div style="font-size:12px">${dist} m</div></div>`;
    marker.addEventListener('click', ()=> onMarkerClick(p));
    markersEl.appendChild(marker);
  });
  status.textContent = `GPS ok • Heading: ${heading!==null?Math.round(heading)+'°':'n/a'} • ${poiData.length} POIs`;
}

function onMarkerClick(p){
  const content = `POI: ${p.title}\nSecret Word: ${p.secret}\nDistance: ${Math.round(distanceTo(userPos.lat,userPos.lon,p.lat,p.lon))} m`;
  const qrData = 'Secret:'+p.secret+';POI:'+p.title;
  const imgUrl = 'https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=' + encodeURIComponent(qrData);
  qrResult.innerHTML = `<div style="display:flex;align-items:center;gap:12px"><img src="${imgUrl}" style="width:120px;border-radius:8px;border:2px solid rgba(255,255,255,0.06)"><div>${escapeHtml(content).replace(/\n/g,'<br>')}<div style="margin-top:8px"><a href="${imgUrl}" target="_blank" style="color:var(--accent);font-weight:700">Open QR Image</a></div></div></div>`;
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

window.addEventListener('deviceorientationabsolute', e=>{
  if(e && e.alpha !== null){
    heading = 360 - e.alpha;
    updateMarkers();
  }
});
window.addEventListener('deviceorientation', e=>{
  if(!heading && e && e.alpha !== null){
    heading = 360 - e.alpha;
    updateMarkers();
  }
});

function startGeolocation(){
  if(!navigator.geolocation) { status.textContent = 'Geolocation not supported'; return; }
  navigator.geolocation.watchPosition(pos => {
    userPos = {lat: pos.coords.latitude, lon: pos.coords.longitude};
    updateMarkers();
  }, err=>{
    status.textContent = 'GPS error: ' + err.message;
  }, {enableHighAccuracy:true, maximumAge:3000, timeout:5000});
}

document.getElementById('btnCenter').addEventListener('click', ()=> updateMarkers());

function buildPoiList(){
  poiListEl.innerHTML = '';
  poiData.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'poiItem';
    el.textContent = p.title + ' • ' + p.secret;
    el.addEventListener('click', ()=> onMarkerClick(p));
    poiListEl.appendChild(el);
  });
}

(async function init(){
  await startCamera();
  buildPoiList();
  startGeolocation();
  status.textContent = 'Camera OK • Waiting for GPS & Heading…';
})();
</script>
</body>
</html>
